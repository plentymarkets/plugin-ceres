{% import "Ceres::Widgets.Helper.TwigBuilder" as Twig %}
{% import "Ceres::Widgets.Helper.WidgetHelper" as WidgetHelper %}
{% import "Ceres::PageDesign.Macros.ItemName" as ItemName %}

{% set customClass = widget.settings.customClass.mobile %}
{% set spacingSettings = widget.settings.spacing %}
{% set inlinePadding   = WidgetHelper.getInlineSpacings(spacingSettings, spacingSettings.customPadding.mobile, "") %}
{% set inlineMargin    = WidgetHelper.getInlineSpacings(spacingSettings, "", spacingSettings.customMargin.mobile) %}
{% set spacingPadding  = WidgetHelper.getSpacingClasses(spacingSettings, spacingSettings.customPadding.mobile, "") %}
{% set spacingMargin   = WidgetHelper.getSpacingClasses(spacingSettings, "", spacingSettings.customMargin.mobile) %}
{% set inlinePaddingT   = WidgetHelper.getInlineSpacings(spacingSettings, spacingSettings.customPadding.mobile, "", ["top"]) %}
{% set spacingPaddingT  = WidgetHelper.getSpacingClasses(spacingSettings, spacingSettings.customPadding.mobile, "", ["top"]) %}

<div class="widget widget-purchased-items widget-{{ widget.settings.appearance.mobile | default("primary") }}
    {% if customClass | length > 0 %} {{ customClass }}{% endif %}
    {% if spacingMargin | length > 0 %} {{ spacingMargin }}{% endif %}"
    {% if inlineMargin | length > 0 %} style="{{ inlineMargin }}"{% endif %}>

    <div class="confirmation-order-list">
        {% for item in orderData.order.orderItems %}
            {% if item.itemVariationId > 0 and not ('[-]' in item.orderItemName) %}
                {% set currentVariationId = item.itemVariationId | trimNewlines %}

                <article class="cmp cmp-order-item">
                    <a href="{{ orderData.itemURLs | getObjectValue(currentVariationId) }}" class="item-image">
                        <img src="{{ orderData.itemImages | getObjectValue(currentVariationId) }}" alt="{{ item.orderItemName }}" title="{{ item.orderItemName }}" class="{% if spacingPaddingT | length > 0 %} {{ spacingPaddingT }} {% endif %}" {% if inlinePaddingT | length > 0 %} style="{{ inlinePaddingT }}"{% endif %}>
                    </a>
                    <div class="item-details small">
                        <a href="{{ orderData.itemURLs | getObjectValue(currentVariationId)  }}" class="clearfix">
                            <div class="item-name text-appearance {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"{% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                                {{ ItemName.get(item.orderItemName, item.bundleType) }}
                            </div>
                        </a>

                        {% if splitItemBundle != "1" and item.bundleType == "bundle" %}
                            <div class="mb-3 small {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}" {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                                {% for bundleComponent in item.bundleComponents %}
                                    <div>
                                        <span class="text-muted">{{ bundleComponent.quantity }} x</span>
                                        <a class="text-appearance" href="{{ bundleComponent.data | itemURL }}"> {{ bundleComponent.data | itemName }} </a>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% set itemAmount = item.amounts[0] %}
                        {% for amount in item.amouts if not amout.isSystemCurrency %}
                            {% set itemAmount = amount %}
                        {% endfor %}

                        {% set itemPrice = 0 %}
                        {% if orderData.highlightNetPrices %}
                            {% set itemPrice = itemAmount.priceOriginalNet %}
                            {% set discountAmount = itemAmount.priceOriginalNet - itemAmount.priceNet %}
                            {% set itemPriceTotal = item.quantity * itemAmount.priceNet %}
                        {% else %}
                            {% set itemPrice = itemAmount.priceOriginalGross %}
                            {% set discountAmount = itemAmount.priceOriginalGross - itemAmount.priceGross %}
                            {% set itemPriceTotal = item.quantity * itemAmount.priceGross %}
                        {% endif %}

                        <div class="row {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"
                                {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                            <strong class="col-6 col-sm-3 col-md-5">{{ trans("Ceres::Template.orderConfirmationPricePerPiece") }}</strong>
                            <span class="col-6 col-sm-9 col-md-7 text-right">{{ itemPrice | formatMonetary( itemAmount.currency ) }}</span>
                        </div>
                        {% if discountAmount > 0 %}
                            <div class="row rebate-hint {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"
                                {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                                <strong class="col-6 col-sm-3 col-md-5">{{ trans("Ceres::Template.orderConfirmationItemDiscount") }}</strong>
                                <span class="col-6 col-sm-9 col-md-7 text-right">{{ discountAmount | formatMonetary( itemAmount.currency ) }}</span>
                            </div>
                        {% endif %}
                        <div class="row {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"
                                {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                            <strong class="col-6 col-sm-3 col-md-5">{{ trans("Ceres::Template.orderConfirmationQuantity") }}</strong>
                            <span class="col-6 col-sm-9 col-md-7 text-right">{{ item.quantity }}</span>
                        </div>

                        {% if item.orderProperties %}
                            <div class="row mb-1 {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"
                                {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                                <strong class="col-6 col-sm-3 col-md-5">Bestellmerkmale</strong>
                            </div>

                            <div id="collapseOrderProperties" class="collapse row small pl-4{% if isPreview %} show{% endif %}{% if spacingPadding | length > 0 %} {{ spacingPadding }}{% endif %}" {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                                {% for property in item.orderProperties %}
                                <strong class="col-12 mt-1 item-word-break">{{ property | propertyName }}</strong>
                                    {% if property.type == 'file' %}
                                    <span class="col-12 item-word-break">
                                        {% set splitPath = property.value |split('/') %}
                                        {% set filename = '' %}
                                        {% set path = '' %}

                                        {% for temp in splitPath %}
                                            {% if loop.first %}
                                                {% set path =  temp %}
                                            {% elseif loop.last %}
                                                {% set filename = temp %}
                                            {% else %}
                                                {% set path =  path ~ '/' ~ temp %}
                                            {% endif %}
                                        {% endfor %}

                                        <a class="text-appearance" href="{{ urls.orderPropertyFile(path) }}?filename={{ filename }}{% if services.customer.getContactId() == 0 %}&orderId={{ orderData.order.id }}{% endif %}" target="_blank">
                                            <i class="fa fa-external-link" aria-hidden="true"></i>
                                            {{ splitPath | last }}
                                        </a>
                                    </span>
                                    {% elseif property.type == "selection" %}
                                    <span class="col-12 item-word-break">
                                        {{ property | propertySelectionValueName }}
                                    </span>
                                    {% elseif property.type | length > 0 %}
                                    <span class="col-12 item-word-break">{{ property.value }}</span>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <label 
                                class="btn-collapse mb-0 collapsed"
                                data-toggle="collapse" 
                                data-target="#collapseOrderProperties" 
                                aria-expanded="false" 
                                aria-controls="collapseOrderProperties" 
                                data-show-more="{{ trans("Ceres::Template.basketShowMore") }}" 
                                data-show-less="{{ trans("Ceres::Template.basketShowLess") }}">
                                <i class="fa fa-caret-down fa-lg"></i>
                            </label>
                        {% endif %}

                        <div class="row {% if spacingPadding | length > 0 %}{{ spacingPadding }}{% endif %}"
                                {% if inlinePadding | length > 0 %} style="{{ inlinePadding }}"{% endif %}>
                            <strong class="col-6 col-sm-3 col-md-5">{{ trans("Ceres::Template.orderConfirmationTotal") }}</strong>
                            <strong class="col-6 col-sm-9 col-md-7 text-right">{{ itemPriceTotal | formatMonetary( itemAmount.currency ) }}</strong>
                        </div>
                    </div>
                </article>
            {% endif %}
        {% endfor %}
    </div>
</div>
