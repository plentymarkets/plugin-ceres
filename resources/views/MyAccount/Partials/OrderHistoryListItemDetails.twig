{% import "Ceres::PageDesign.Macros.LayoutContainer" as LayoutContainer %}
{% import "Ceres::PageDesign.Macros.ItemName" as ItemName %}

{% set initialMaxItemsPerOrder = 5 %}
{% set basketTotalsCurrency = totals.currency %}

<div>
    <div class="row container_middle border">
        <div class="col-md-7 products border">
            <div class="row">
                {% set rebatedAmountTotalGross = 0 %}
                {% set rebatedAmountTotalNet = 0 %}
                {% set rebatedAmountTotal = 0 %}

                {% for item in orderData.order.orderItems %}
                    
                    {% if loop.index == initialMaxItemsPerOrder + 1 %}
                        <div v-if="showAllOrderItems">
                    {% endif %}

                    {% if item.itemVariationId > 0 and not ('[-]' in item.orderItemName) %}
                        {% set currentVariationId = item.itemVariationId | trimNewlines %}

                        {% if item.amounts[0].discount > 0 %}
                            {% if item.amounts[0].isPercentage ==  "1" %}
                                {% set rebatedAmountItemGross = (item.quantity * (((item.amounts[0].priceGross  / (100 - item.amounts[0].discount)) * 100) - item.amounts[0].priceGross)) %}
                                {% set rebatedAmountItemNet = (item.quantity * (((item.amounts[0].priceNet  / (100 - item.amounts[0].discount)) * 100) - item.amounts[0].priceNet)) %}
                            {% else %}
                                {% set rebatedAmountItemGross = (item.quantity * item.amounts[0].discount)  %}
                            {% endif %}
                            {% set rebatedAmountTotalGross = rebatedAmountTotalGross + rebatedAmountItemGross %}
                            {% set rebatedAmountTotalNet = rebatedAmountTotalNet + rebatedAmountItemNet %}
                        {% endif %}

                        {% set itemPrice = 0 %}
                        {% set rebatedAmount = 0 %}

                        {% if orderData.highlightNetPrices %}
                            {% set itemPrice = item.amounts[0].priceNet %}
                            {% set rebatedAmount = rebatedAmountItemNet %}
                            {% set rebatedAmountTotal = rebatedAmountTotalNet %}
                        {% else %}
                            {% set itemPrice = item.amounts[0].priceGross %}
                            {% set rebatedAmount = rebatedAmountItemGross %}
                            {% set rebatedAmountTotal = rebatedAmountTotalGross %}
                        {% endif %}

                        <div class="col-sm-12 item py-3">
                            <a href="{{ orderData.itemURLs | getObjectValue(currentVariationId) }}">
                                <img class="d-inline-block" src="{{ orderData.itemImages | getObjectValue(currentVariationId) }}" alt="{{ item.orderItemName }}" title="{{ item.orderItemName }}">
                            </a>

                            <div class="d-inline-block item-description">
                                <div><a class="text-primary" href="{{ orderData.itemURLs | getObjectValue(currentVariationId)  }}">{{ ItemName.get(item.orderItemName, item.bundleType) }}</a></div>
                                <div>{{ trans("Ceres::Template.orderHistoryPricePerPiece") }}: {{ (itemPrice + rebatedAmount) | formatMonetary( item.amounts[0].currency ) }}</div>
                                <div>{{ trans("Ceres::Template.orderHistoryQuantity") }}: {{ item.quantity }}</div>
                                <div>{{ trans("Ceres::Template.orderHistoryTotal") }}: {{ (item.quantity * (itemPrice + rebatedAmount)) | formatMonetary( item.amounts[0].currency ) }}</div>

                                {% if splitItemBundle != "1" and item.bundleType == "bundle" %}
                                    <div class="item-bundle">
                                        {% for bundleComponent in item.bundleComponents %}
                                            <div>
                                                <span class="text-muted">{{ bundleComponent.quantity }} x</span>
                                                <a href="{{ bundleComponent.data | itemURL }}"> {{ bundleComponent.data | itemName }} </a>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                {% if item.orderProperties %}
                                    {% for property in item.orderProperties %}
                                        <div class="row">
                                            <strong class="col-6 col-sm-3 col-md-5 item-word-break">{{ property.name }}</strong>
                                            {% if property.type == 'file' %}
                                                <span class="col-6 col-sm-9 item-word-break">
                                                    {% set splitPath = property.value |split('/') %}
                                                    {% set filename = '' %}
                                                    {% set path = '' %}

                                                    {% for temp in splitPath %}
                                                        {% if loop.first %}
                                                            {% set path =  temp %}
                                                        {% elseif loop.last %}
                                                            {% set filename = temp %}
                                                        {% else %}
                                                            {% set path =  path ~ '/' ~ temp %}
                                                        {% endif %}
                                                    {% endfor %}


                                                    <a href="order-property-file/{{ path }}?filename={{ filename }}" target="_blank">
                                                        <i class="fa fa-external-link" aria-hidden="true"></i>
                                                        {{ splitPath | last }}
                                                    </a>
                                                </span>
                                            {% elseif property.type | length > 0 %}
                                                <span class="col-6 col-sm-9 col-md-7 item-word-break">{{ property.value }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

            {% if orderData.order.orderItems | length > initialMaxItemsPerOrder %}
                </div>
            {% endif %}

            </div>

            {% if orderData.order.orderItems | length > initialMaxItemsPerOrder %}
                <div class="row mb-2">
                    <div class="col-sm-12 text-center ">
                        <a class="btn text-primary collapsed" @click="showAllOrderItems = !showAllOrderItems">
                            <template v-if="showAllOrderItems">
                                {{ trans("Ceres::Template.orderHistoryReturnShowLess") }}
                            </template>
                            <template v-else>
                                {{ trans("Ceres::Template.returnHistoryReturnShowMore") }}
                            </template>
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
        <div class="col-md-5 sum">
            <div class="cmp cmp-totals row pt-3">
                <div class="col-sm-12">
                    <h3>{{ trans("Ceres::Template.orderHistorySum") }}</h3>
                    <div>
                        <dl>
                            <dt{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ trans("Ceres::Template.orderHistoryValue") }} ({{ trans("Ceres::Template.orderHistoryNet") }})
                            </dt><!--
                        --><dd{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ (totals.itemSumNet + rebatedAmountTotalNet) | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
    
                            <dt{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ trans("Ceres::Template.orderHistoryValue") }} ({{ trans("Ceres::Template.orderHistoryGross") }})
                            </dt><!--
                        --><dd{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {% if orderData.order.amounts[0].isNet %}
                                    {{ (totals.itemSumGross + rebatedAmountTotalNet) | formatMonetary( basketTotalsCurrency ) }}
                                {% else %}
                                    {{ (totals.itemSumGross + rebatedAmountTotalGross) | formatMonetary( basketTotalsCurrency ) }}
                                {% endif %}
                            </dd>
                            {% if rebatedAmountTotal > 0 %}
                                <dt class="rebate-hint">
                                    {{ trans("Ceres::Template.orderHistoryRebate") }}
                                </dt><!--
                                --><dd class="rebate-hint">
                                {{ rebatedAmountTotal| formatMonetary( basketTotalsCurrency ) }}
                            </dd>
                                <dt {% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                    {{ trans("Ceres::Template.orderHistorySubTotal") }} ({{ trans("Ceres::Template.orderHistoryNet") }})
                                </dt><!--
                                --><dd {% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ totals.itemSumNet | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
                                <dt {% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                    {{ trans("Ceres::Template.orderHistorySubTotal") }} ({{ trans("Ceres::Template.orderHistoryGross") }})
                                </dt><!--
                                --><dd {% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ totals.itemSumGross | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
                            {% endif %}
                            <dt{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ trans("Ceres::Template.orderHistoryShippingCosts") }} ({{ trans("Ceres::Template.orderHistoryNet") }})
                            </dt><!--
                        --><dd{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ totals.shippingNet | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
                            <dt{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ trans("Ceres::Template.orderHistoryShippingCosts") }} ({{ trans("Ceres::Template.orderHistoryGross") }})
                            </dt><!--
                        --><dd{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ totals.shippingGross | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
    
                            <hr>
    
                            {% set grossNet = LayoutContainer.show("Ceres::OrderConfirmation.GrossNetReplace", orderData.order) %}
                            {% if grossNet|trim is not empty %}
                                {{ grossNet }}
                            {% else %}
                                <dt{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                    {{ trans("Ceres::Template.orderHistoryTotalSum") }} ({{ trans("Ceres::Template.orderHistoryNet") }})
                                </dt><!--
                                --><dd{% if orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                {{ totals.totalNet | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
    
                                {% if totals.couponType == 'promotional' and (totals.couponValue | trimNewlines) != 0 %}
                                    <dt{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                        {{ trans("Ceres::Template.orderHistoryCoupon") }}
                                    </dt><!--
                                    --><dd{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                    {{ totals.couponValue | formatMonetary( basketTotalsCurrency ) }}
                                </dd>
                                {% endif %}
    
                                {% if not orderData.order.amounts[0].isNet %}
                                    <div class="vatTotals">
                                        {% for vat in totals.vats %}
                                            <dt>
                                                {{ trans("Ceres::Template.orderHistoryVAT") }} {{ vat.rate }}%
                                            </dt><!--
                                            --><dd>
                                                {{ vat.value | formatMonetary( basketTotalsCurrency ) }}
                                            </dd>
                                        {% endfor %}
                                    </div>
                                {% endif %}
    
                                <div class="totalSum">
                                    <hr>
                                    <dt{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                        {{ trans("Ceres::Template.orderHistoryTotalSum") }} ({{ trans("Ceres::Template.orderHistoryGross") }})
                                    </dt><!--
                                    --><dd{% if not orderData.highlightNetPrices %} class="font-weight-bold"{% endif %}>
                                        {{ totals.totalGross | formatMonetary( basketTotalsCurrency ) }}
                                    </dd>
                                </div>
                            {% endif %} <!-- GrossNetReplace|else -->
                            {% if totals.couponType == 'sales' and (totals.couponValue | trimNewlines) != 0 %}
                                <dt>
                                    {{ trans("Ceres::Template.orderHistoryCoupon") }}
                                </dt><!--
                                      --><dd>
                                {{ totals.couponValue | formatMonetary( basketTotalsCurrency ) }}
                            </dd>
                                <dt>
                                    <strong>{{ trans("Ceres::Template.orderHistoryOpenAmount") }}</strong>
                                </dt><!--
                                        --><dd>
                                <strong>{{ totals.openAmount | formatMonetary( basketTotalsCurrency ) }}</strong>
                            </dd>
                            {% endif %}
                            {{ LayoutContainer.show("Ceres::OrderConfirmation.AfterTotals", orderData.order) }}
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row container_bottom border py-4">
        <div class="col-md-7">
            <div class="row">
                <div class="col-sm-4">                            
                    <p>
                        <strong>{{ trans("Ceres::Template.orderHistoryPaymentMethod") }}</strong>
                        <br>
                        <span id="payment_name_{{ orderData.order.id }}">{{ orderData.paymentMethodName }}</span>
                    </p>
                    <p>
                        <strong>{{ trans("Ceres::Template.orderHistoryPaymentStatus") }}</strong>
                        <br>
                        <span id="payment_state_{{ orderData.order.id }}">{{ trans("Ceres::Template.orderHistoryPaymentStatus_" ~ orderData.paymentStatus) }}</span>
                    </p>
                    <p><strong>{{ trans("Ceres::Template.orderHistoryShippingProfile") }}</strong><br>{{ orderData.shippingProvider }} - {{ orderData.shippingProfileName }}</p>
                </div>
                <div class="col-sm-8">
                    <div class="row">
                        <div class="col-sm-6">
                            <h5 class="mb-3"><strong>{{ trans("Ceres::Template.orderHistoryInvoiceAddress") }}</strong></h5>
                            <address-header :address="{{ orderData.order.billingAddress | json_encode }}"></address-header>
                        </div>
                        <div class="col-sm-6">
                            <h5 class="mb-3"><strong>{{ trans("Ceres::Template.orderHistoryShippingAddress") }}</strong></h5>
                            {% if orderData.order.billingAddress.id == orderData.order.deliveryAddress.id %}
                                <span>
                                    {{ trans("Ceres::Template.orderHistorySameAsInvoice") }}
                                </span>
                            {% else %}
                                <address-header :address="{{orderData.order.deliveryAddress | json_encode }}"></address-header>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            {# <a href="#" class="btn btn-primary btn-block">Zahlungsänderung<i class="fa fa-pencil-square-o" aria-hidden="true"></i></a> #}
            <template v-if="allowPaymentProviderChange">
                <change-payment-method
                    template="#vue-change-payment-method"
                    :current-order="{{ orderData.order | json_encode }}"
                    :change-possible="{{ orderData.allowPaymentMethodSwitchFrom | json_encode }}"
                    :allowed-payment-methods="{{ orderData.paymentMethodListForSwitch | json_encode }}"
                    :payment-status="{{ orderData.paymentStatus | json_encode }}"
                    current-template="tpl.my-account"
                    :current-payment-method-name="{{ orderData.paymentMethodName | json_encode }}">
                </change-payment-method>
                {{ LayoutContainer.show("Ceres::MyAccount.OrderHistoryPaymentInformation", orderData.order) }}
            </template>
            
            {% if orderData.isReturnable %}
                <a v-waiting-animation-infinite class="btn btn-primary btn-block" href="/returns/{{ orderData.order.id }}">
                    <i class="fa fa-repeat" aria-hidden="true"></i>
                    {{ trans("Ceres::Template.orderHistoryReturnSendBack") }}
                </a>
            {% endif %}
            
            <order-documents :documents="{{ orderData.order.documents | json_encode }}"></order-documents>
        </div>
    </div>
</div>
